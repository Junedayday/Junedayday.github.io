<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="Blog信息">
<meta property="og:type" content="website">
<meta property="og:title" content="Junedayday Blog">
<meta property="og:url" content="http://example.com/page/9/index.html">
<meta property="og:site_name" content="Junedayday Blog">
<meta property="og:description" content="Blog信息">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Junedayday">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/9/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Junedayday Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Junedayday Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">六月天天的个人博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Junedayday</p>
  <div class="site-description" itemprop="description">Blog信息</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">102</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/grpc/grpc-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/grpc/grpc-1/" class="post-title-link" itemprop="url">gRPC源码分析（一）：gRPC的系统调用过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 19:34:41" itemprop="dateCreated datePublished" datetime="2021-02-20T19:34:41+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">源码阅读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>参考<a target="_blank" rel="noopener" href="https://grpc.io/docs/quickstart/go/">官方文档</a>，进行部署并运行成功</p>
<h2 id="分析思路：GRPC是怎么实现方法调用的"><a href="#分析思路：GRPC是怎么实现方法调用的" class="headerlink" title="分析思路：GRPC是怎么实现方法调用的"></a>分析思路：GRPC是怎么实现方法调用的</h2><ol>
<li>分析PB生成的对应文件</li>
<li>运行server</li>
<li>运行client</li>
</ol>
<h2 id="1-分析PB生成的对应文件"><a href="#1-分析PB生成的对应文件" class="headerlink" title="1. 分析PB生成的对应文件"></a>1. 分析PB生成的对应文件</h2><h3 id="HelloRequest-HelloReply-结构分析"><a href="#HelloRequest-HelloReply-结构分析" class="headerlink" title="HelloRequest/HelloReply 结构分析"></a>HelloRequest/HelloReply 结构分析</h3><p>存在三个冗余字段 <code>XXX_NoUnkeyedLiteral</code> <code>XXX_unrecognized</code> <code>XXX_sizecache</code></p>
<p>这部分主要是兼容proto2的，我们暂时不用细究</p>
<h3 id="GreeterClient客户端"><a href="#GreeterClient客户端" class="headerlink" title="GreeterClient客户端"></a>GreeterClient客户端</h3><p>传入一个 cc grpc.ClientConnInterface 客户端连接</p>
<p>可调用的方法为SayHello，其内部的method为”/helloworld.Greeter/SayHello”，也就是<code>/&#123;package&#125;.&#123;service&#125;/&#123;method&#125;</code> ，作为一个唯一的URI</p>
<h3 id="GreeterServer服务端"><a href="#GreeterServer服务端" class="headerlink" title="GreeterServer服务端"></a>GreeterServer服务端</h3><p>需要自己实现一个SayHello的方法</p>
<p>其中有个 UnimplementedGreeterServer 的接口，可以嵌入到对应的server结构体中（有方法未实现时，会返回codes.Unimplemented）</p>
<h2 id="2-运行server"><a href="#2-运行server" class="headerlink" title="2. 运行server"></a>2. 运行server</h2><h3 id="定义server"><a href="#定义server" class="headerlink" title="定义server"></a>定义server</h3><p>这里pb.UnimplementedGreeterServer被嵌入了server结构，所以即使没有实现SayHello方法，编译也能通过。</p>
<p>但是，我们通常要强制server在编译期就必须实现对应的方法，所以生产中建议不嵌入。</p>
<h3 id="实现自己的业务逻辑"><a href="#实现自己的业务逻辑" class="headerlink" title="实现自己的业务逻辑"></a>实现自己的业务逻辑</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">SayHello</span><span class="params">(ctx context.Context, in *pb.HelloRequest)</span> <span class="params">(*pb.HelloReply, error)</span></span>&#123;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="注册TCP监听端口"><a href="#注册TCP监听端口" class="headerlink" title="注册TCP监听端口"></a>注册TCP监听端口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<p>因为gRPC的应用层是基于HTTP2的，所以这里不出意外，监听的是tcp端口</p>
<h3 id="grpc-NewServer"><a href="#grpc-NewServer" class="headerlink" title="grpc.NewServer()"></a>grpc.NewServer()</h3><ol>
<li>入参为选项参数options</li>
<li>自带一组defaultServerOptions，最大发送size、最大接收size、连接超时、发送缓冲、接收缓冲</li>
<li><code>s.cv = sync.NewCond(&amp;s.mu)</code> 条件锁，用于关闭连接</li>
<li>全局参数 <code>EnableTraciing</code> ，会调用golang.org/x/net/trace 这个包</li>
</ol>
<h3 id="pb-RegisterGreeterServer-s-amp-server"><a href="#pb-RegisterGreeterServer-s-amp-server" class="headerlink" title="pb.RegisterGreeterServer(s, &amp;server{})"></a>pb.RegisterGreeterServer(s, &amp;server{})</h3><p>对比自己创建的server和pb中定义的server，确定每个方法都已经实现</p>
<p>service放在 <code>m map[string]*service</code> 中，所以一个server可以放多个proto定义的服务</p>
<p>内部的method和stream放在 service 中的两个map中</p>
<h3 id="s-Serve-lis"><a href="#s-Serve-lis" class="headerlink" title="s.Serve(lis)"></a>s.Serve(lis)</h3><ol>
<li>listener 放到内部的map中</li>
<li>for循环，进行tcp连接，这一部分和http源码中的ListenAndServe极其类似</li>
<li>在协程中进行handleRawConn</li>
<li>将tcp连接封装对应的creds认证信息</li>
<li>新建newHTTP2Transport传输层连接</li>
<li>在协程中进行serveStreams，而http1这里为阻塞的</li>
<li>函数HandleStreams中参数为2个函数，前者为处理请求，后者用于trace</li>
<li>进入handleStream，前半段被拆为service，后者为method，通过map查找</li>
<li>method在processUnaryRPC处理，stream在processStreamingRPC处理，这两块内部就比较复杂了，涉及到具体的算法，以后有时间细读</li>
</ol>
<h2 id="3-运行client"><a href="#3-运行client" class="headerlink" title="3. 运行client"></a>3. 运行client</h2><h3 id="grpc-Dial"><a href="#grpc-Dial" class="headerlink" title="grpc.Dial"></a>grpc.Dial</h3><p>新建一个conn连接，这里是一个支持HTTP2.0的客户端，暂不细讲</p>
<h3 id="pb-NewGreeterClient-conn"><a href="#pb-NewGreeterClient-conn" class="headerlink" title="pb.NewGreeterClient(conn)"></a>pb.NewGreeterClient(conn)</h3><p>新建一个client，包装对应的method，方便调用SayHello</p>
<h3 id="调用SayHello"><a href="#调用SayHello" class="headerlink" title="调用SayHello"></a>调用SayHello</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r, err := c.SayHello(ctx, &amp;pb.HelloRequest&#123;Name: name&#125;)</span><br></pre></td></tr></table></figure>

<ol>
<li>核心调用的是 Invoke 方法，具体实现要看grpc.ClientConn中</li>
<li>grpc.ClientConn中实现了Invoke方法，在call.go文件中，详情都在invoke中</li>
</ol>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-8/" class="post-title-link" itemprop="url">Go编程模式 - 8-装饰、管道和访问者模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:32:09" itemprop="dateCreated datePublished" datetime="2021-02-20T18:32:09+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#Decoration">装饰模式</a></li>
<li><a href="#Pipeline">管道模式</a></li>
<li><a href="#Visitorl">访问者模式</a></li>
</ul>
<p>今天，我会抛开官方的定义，简单介绍一下三种设计模式。</p>
<blockquote>
<p> 后续会有介绍Go语言设计模式Design Patterns的系列，会更具理论性。</p>
</blockquote>
<h2 id="Decoration"><a href="#Decoration" class="headerlink" title="Decoration"></a>Decoration</h2><p>代码实例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decorator</span><span class="params">(f <span class="keyword">func</span>(s <span class="keyword">string</span>)</span>) <span class="title">func</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Started&quot;</span>)</span><br><span class="line">		f(s)</span><br><span class="line">		fmt.Println(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一句话解释：<strong>在函数f前后，添加装饰性的功能函数，但不改变函数本身的行为</strong>。</p>
<p>这种设计模式，对一些被高频率调用的代码非常有用：</p>
<ol>
<li>HTTP Server被调用的handler</li>
<li>HTTP Client发送请求</li>
<li>对MySQL的操作</li>
</ol>
<p>而装饰性的功能，常见的有：</p>
<ol>
<li>打印相关的日志信息（Debug中非常有用！）</li>
<li>耗时相关的计算</li>
<li>监控埋点</li>
</ol>
<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><p>代码示例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HttpHandlerDecorator <span class="function"><span class="keyword">func</span><span class="params">(http.HandlerFunc)</span> <span class="title">http</span>.<span class="title">HandlerFunc</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handler</span><span class="params">(h http.HandlerFunc, decors ...HttpHandlerDecorator)</span> <span class="title">http</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> decors &#123;</span><br><span class="line">        d := decors[<span class="built_in">len</span>(decors)<span class="number">-1</span>-i] <span class="comment">// iterate in reverse</span></span><br><span class="line">        h = d(h)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一句话解释：<strong>用不定参数的特性，将入参中的函数，逐个应用到对象上</strong></p>
<blockquote>
<p>看到这里，如果你能想起之前 <code>Functional Option</code> 那篇，会发现有这块的影子。</p>
</blockquote>
<p>主要应用于： 有多种可选择的配置（对应Field）或处理（对应方法）的复杂对象。</p>
<p>耗子叔在后面又增加了一些用Goroutine+Channel的方式，其实就是讲Channel作为一个管道的承载体。</p>
<h2 id="Visitor"><a href="#Visitor" class="headerlink" title="Visitor"></a>Visitor</h2><p>关于访问者设计者模式，我之前在Kubernetes源码分析中专门分析了源码。今天，我们也简单地过一下。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义访问的函数类型</span></span><br><span class="line"><span class="keyword">type</span> VisitorFunc <span class="function"><span class="keyword">func</span><span class="params">(*Info, error)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Visitor接口设计</span></span><br><span class="line"><span class="keyword">type</span> Visitor <span class="keyword">interface</span> &#123;</span><br><span class="line">	Visit(VisitorFunc) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 资源对象</span></span><br><span class="line"><span class="keyword">type</span> Info <span class="keyword">struct</span> &#123;</span><br><span class="line">	Namespace   <span class="keyword">string</span></span><br><span class="line">	Name        <span class="keyword">string</span></span><br><span class="line">	OtherThings <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将Visitor函数应用到资源对象上</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(info *Info)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fn(info, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后看其中一个实现：NameVisitor，其余的也类似，这样就能注入对应的Visitor</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NameVisitor <span class="keyword">struct</span> &#123;</span><br><span class="line">	visitor Visitor</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v NameVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> v.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">// 这里是运行入参中的VisitorFunc，这一块的逻辑有点像pipeline</span></span><br><span class="line">		err = fn(info, err)</span><br><span class="line">		<span class="comment">// NameVisitor自己实现的Visit逻辑</span></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，Kubernetes中的Visitor还有进一步的封装，包括遇到错误时的处理，这里不细讲，有兴趣的朋友可以看看我对那一篇的分析。</p>
<p>Visitor模式最大的优点就是 <code>解耦了数据和程序</code>。回头看Kubernetes的Visitor应用场景，主要是从各种输入源中解析出资源<code>Info</code>。这个过程中Info是数据，各类解析方法是资源。</p>
<p>所以，我认为Visitor模式比较适合的是：<strong>目标数据明确，但获取数据的方法多样且复杂</strong>。但由于多层Visitor调用复杂，建议大家可以在外面再简单地封一层，提供常用的几种Visitor组合后的接口，供使用方调用。</p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-7/" class="post-title-link" itemprop="url">Go编程模式 - 7-代码生成</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:32:05" itemprop="dateCreated datePublished" datetime="2021-02-20T18:32:05+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#Simple-Script">简单脚本准备</a><ul>
<li><a href="#Template">模板文件</a></li>
<li><a href="#Shell">运行脚本</a></li>
<li><a href="#Generate-File">入口文件</a></li>
<li><a href="#Generation">运行原理</a></li>
</ul>
</li>
<li><a href="#genny">类型替换工具genny</a></li>
<li><a href="#go-bindata">任意文件转Go</a></li>
<li><a href="#stringer">字符串生成工具stringer</a></li>
</ul>
<h2 id="Simple-Script"><a href="#Simple-Script" class="headerlink" title="Simple Script"></a>Simple Script</h2><p>为了让大家快速了解这块，我们从一个最简单的例子入手。</p>
<h3 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h3><p>首先创建一个模板Go文件，即容器模板：container.tmp.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> PACKAGE_NAME</span><br><span class="line"><span class="keyword">type</span> GENERIC_NAMEContainer <span class="keyword">struct</span> &#123;</span><br><span class="line">    s []GENERIC_TYPE</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGENERIC_NAMEContainer</span><span class="params">()</span> *<span class="title">GENERIC_NAMEContainer</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;GENERIC_NAMEContainer&#123;s: []GENERIC_TYPE&#123;&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *GENERIC_NAMEContainer)</span> <span class="title">Put</span><span class="params">(val GENERIC_TYPE)</span></span> &#123;</span><br><span class="line">    c.s = <span class="built_in">append</span>(c.s, val)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *GENERIC_NAMEContainer)</span> <span class="title">Get</span><span class="params">()</span> <span class="title">GENERIC_TYPE</span></span> &#123;</span><br><span class="line">    r := c.s[<span class="number">0</span>]</span><br><span class="line">    c.s = c.s[<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h3><p>生成的shell脚本，gen.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">SRC_FILE=$&#123;1&#125;</span><br><span class="line">PACKAGE=$&#123;2&#125;</span><br><span class="line">TYPE=$&#123;3&#125;</span><br><span class="line">DES=$&#123;4&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">uppcase the first char</span></span><br><span class="line">PREFIX=&quot;$(tr &#x27;[:lower:]&#x27; &#x27;[:upper:]&#x27; &lt;&lt;&lt; $&#123;TYPE:0:1&#125;)$&#123;TYPE:1&#125;&quot;</span><br><span class="line"></span><br><span class="line">DES_FILE=$(echo $&#123;TYPE&#125;| tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)_$&#123;DES&#125;.go</span><br><span class="line"></span><br><span class="line">sed &#x27;s/PACKAGE_NAME/&#x27;&quot;$&#123;PACKAGE&#125;&quot;&#x27;/g&#x27; $&#123;SRC_FILE&#125; | \</span><br><span class="line">    sed &#x27;s/GENERIC_TYPE/&#x27;&quot;$&#123;TYPE&#125;&quot;&#x27;/g&#x27; | \</span><br><span class="line">    sed &#x27;s/GENERIC_NAME/&#x27;&quot;$&#123;PREFIX&#125;&quot;&#x27;/g&#x27; &gt; $&#123;DES_FILE&#125;</span><br></pre></td></tr></table></figure>

<p>四个参数分别为</p>
<ul>
<li>源文件名</li>
<li>包名</li>
<li>类型</li>
<li>文件后缀名</li>
</ul>
<h3 id="Generate-File"><a href="#Generate-File" class="headerlink" title="Generate File"></a>Generate File</h3><p>最后，增加一个创建代码的go文件。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:generate ./gen.sh ./template/container.tmp.go gen uint32 container</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateUint32Example</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> u <span class="keyword">uint32</span> = <span class="number">42</span></span><br><span class="line">    c := NewUint32Container()</span><br><span class="line">    c.Put(u)</span><br><span class="line">    v := c.Get()</span><br><span class="line">    fmt.Printf(<span class="string">&quot;generateExample: %d (%T)\n&quot;</span>, v, v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:generate ./gen.sh ./template/container.tmp.go gen string container</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateStringExample</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> s <span class="keyword">string</span> = <span class="string">&quot;Hello&quot;</span></span><br><span class="line">    c := NewStringContainer()</span><br><span class="line">    c.Put(s)</span><br><span class="line">    v := c.Get()</span><br><span class="line">    fmt.Printf(<span class="string">&quot;generateExample: %s (%T)\n&quot;</span>, v, v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Generation"><a href="#Generation" class="headerlink" title="Generation"></a>Generation</h3><p>我们运行一下 <code>go generate</code>，就能产生对应的文件。</p>
<ol>
<li>运行go generate，工具会扫描所有的文件</li>
<li>如果发现注释有带 go:generate的，会自动运行后面的命令</li>
<li>通过命令生成的代码，会在源文件添加提示，告诉他人这是自动生成的代码，不要编辑</li>
</ol>
<p>因此，我们不仅仅可以用<code>shell</code>脚本，也可以用各种二进制工具来生成代码。值得一提的是，像Kubernetes这种重量级的项目，大量地应用了这种特性。后面我也会和大家分享在开发web项目中的应用。</p>
<p>下面，我也来介绍几个个人认为比较有用的工具。</p>
<h2 id="genny"><a href="#genny" class="headerlink" title="genny"></a>genny</h2><p>源项目链接：<a target="_blank" rel="noopener" href="https://github.com/cheekybits/genny">https://github.com/cheekybits/genny</a></p>
<h3 id="Go文件示例"><a href="#Go文件示例" class="headerlink" title="Go文件示例"></a>Go文件示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/cheekybits/genny/generic&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> this is how easy it is to define a generic type</span></span><br><span class="line"><span class="keyword">type</span> Something generic.Type</span><br><span class="line"></span><br><span class="line"><span class="comment">// SomethingQueue is a queue of Somethings.</span></span><br><span class="line"><span class="keyword">type</span> SomethingQueue <span class="keyword">struct</span> &#123;</span><br><span class="line">  items []Something</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSomethingQueue</span><span class="params">()</span> *<span class="title">SomethingQueue</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;SomethingQueue&#123;items: <span class="built_in">make</span>([]Something, <span class="number">0</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *SomethingQueue)</span> <span class="title">Push</span><span class="params">(item Something)</span></span> &#123;</span><br><span class="line">  q.items = <span class="built_in">append</span>(q.items, item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *SomethingQueue)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">Something</span></span> &#123;</span><br><span class="line">  item := q.items[<span class="number">0</span>]</span><br><span class="line">  q.items = q.items[<span class="number">1</span>:]</span><br><span class="line">  <span class="keyword">return</span> item</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat source.go | genny gen &quot;Something=string&quot;</span><br></pre></td></tr></table></figure>

<p>官方示例还是采用的是shell脚本，建议替换到 go:generate 中，这样的代码更统一</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>可以简单地理解成一个类型替换的工具（PS：擅长用sed脚本的朋友也可直接通过shell脚本实现）</p>
<h2 id="go-bindata"><a href="#go-bindata" class="headerlink" title="go-bindata"></a>go-bindata</h2><p>源网站链接：<a target="_blank" rel="noopener" href="https://github.com/go-bindata/go-bindata">https://github.com/go-bindata/go-bindata</a></p>
<p>go-bindata的功能是将任意格式的源文件，转化为Go代码，使我们无需再去打开文件读取了。</p>
<p>这个工具多用在静态网页转化为Go代码（不符合前后端分离的实践），所以具体的使用方式我就不细讲了，大家有兴趣的可以自行阅读教程。</p>
<p>但它有两个优点值得我们关注：无需再进行文件读取操作、压缩。</p>
<h2 id="stringer"><a href="#stringer" class="headerlink" title="stringer"></a>stringer</h2><p>stringer是官方提供一个字符串工具，我个人非常推荐大家使用</p>
<p>文档链接：<a target="_blank" rel="noopener" href="https://pkg.go.dev/golang.org/x/tools/cmd/stringer">https://pkg.go.dev/golang.org/x/tools/cmd/stringer</a> </p>
<h3 id="Go文件"><a href="#Go文件" class="headerlink" title="Go文件"></a>Go文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> painkiller</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pill <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Placebo Pill = <span class="literal">iota</span></span><br><span class="line">	Aspirin</span><br><span class="line">	Ibuprofen</span><br><span class="line">	Paracetamol</span><br><span class="line">	Acetaminophen = Paracetamol</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="脚本-1"><a href="#脚本-1" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:generate stringer -type=Pill</span></span><br></pre></td></tr></table></figure>

<p>于是，就会生成对应的方法<code>func (Pill) String() string</code>，也就是直接转化成了其命名。</p>
<h3 id="价值"><a href="#价值" class="headerlink" title="价值"></a>价值</h3><p>Go语言在调用 <code>fmt</code> 等相关包时，如果要将某个变量转化为字符串，默认会寻找它的<code>String()</code>方法。</p>
<p>这时，<strong>良好的命名</strong> 能体现出其价值。尤其是在错误码的处理上，无需再去查询错误码对应的错误内容，直接可以通过命名了解。</p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-6/" class="post-title-link" itemprop="url">Go编程模式 - 6-映射、归约与过滤</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:32:02" itemprop="dateCreated datePublished" datetime="2021-02-20T18:32:02+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#Map/Reduce/Filter">映射、规约与过滤</a></li>
<li><a href="#Scenarios">应用场景探索</a></li>
<li><a href="#Generic">泛型</a></li>
</ul>
<h2 id="Map-Reduce-Filter"><a href="#Map-Reduce-Filter" class="headerlink" title="Map/Reduce/Filter"></a>Map/Reduce/Filter</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MapUpCase</span><span class="params">(arr []<span class="keyword">string</span>, fn <span class="keyword">func</span>(s <span class="keyword">string</span>)</span> <span class="title">string</span>) []<span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> newArray = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, it := <span class="keyword">range</span> arr &#123;</span><br><span class="line">		newArray = <span class="built_in">append</span>(newArray, fn(it))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> newArray</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MapLen</span><span class="params">(arr []<span class="keyword">string</span>, fn <span class="keyword">func</span>(s <span class="keyword">string</span>)</span> <span class="title">int</span>) []<span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> newArray = []<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, it := <span class="keyword">range</span> arr &#123;</span><br><span class="line">		newArray = <span class="built_in">append</span>(newArray, fn(it))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> newArray</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reduce</span><span class="params">(arr []<span class="keyword">string</span>, fn <span class="keyword">func</span>(s <span class="keyword">string</span>)</span> <span class="title">int</span>) <span class="title">int</span></span> &#123;</span><br><span class="line">	sum := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, it := <span class="keyword">range</span> arr &#123;</span><br><span class="line">		sum += fn(it)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Filter</span><span class="params">(arr []<span class="keyword">string</span>, fn <span class="keyword">func</span>(n <span class="keyword">string</span>)</span> <span class="title">bool</span>) []<span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> newArray = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, it := <span class="keyword">range</span> arr &#123;</span><br><span class="line">		<span class="keyword">if</span> fn(it) &#123;</span><br><span class="line">			newArray = <span class="built_in">append</span>(newArray, it)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> newArray</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> list = []<span class="keyword">string</span>&#123;<span class="string">&quot;Hao&quot;</span>, <span class="string">&quot;Chen&quot;</span>, <span class="string">&quot;MegaEase&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 元素一对一映射 string-&gt;string</span></span><br><span class="line">	x := MapUpCase(list, <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> strings.ToUpper(s)</span><br><span class="line">	&#125;)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, x)</span><br><span class="line">	<span class="comment">// [HAO CHEN MEGAEASE]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 元素一对一映射 string-&gt;int</span></span><br><span class="line">	y := MapLen(list, <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(s)</span><br><span class="line">	&#125;)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, y)</span><br><span class="line">	<span class="comment">// [3 4 8]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 归约：多个元素-&gt;一个元素</span></span><br><span class="line">	z := Reduce(list, <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(s)</span><br><span class="line">	&#125;)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, z)</span><br><span class="line">	<span class="comment">// 15</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 过滤：过滤不满足条件的元素</span></span><br><span class="line">	f := Filter(list, <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt; <span class="number">3</span></span><br><span class="line">	&#125;)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, f)</span><br><span class="line">	<span class="comment">// [Chen MegaEase]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Scenarios"><a href="#Scenarios" class="headerlink" title="Scenarios"></a>Scenarios</h2><ul>
<li><code>Map</code> 是一对一的场景，是 <strong>循环中对数据加工处理</strong> </li>
<li><code>Reduce</code> 是多对一，是 <strong>数据聚合处理</strong></li>
<li><code>Filter</code>是过滤的处理，是 <strong>数据有效性</strong></li>
</ul>
<p>我们以常见的账单统计相关的功能，我们会遇上大量的此类情况：</p>
<ol>
<li>统计消费总额 - Reduce</li>
<li>统计用户A - Filter</li>
<li>统计本月 - Filter</li>
<li>费用转化为美金 - Map</li>
</ol>
<p>在综合各个因素后，就是大量复杂的、管道式的Map/Reduce/Filter操作。</p>
<blockquote>
<p>延伸思考一下，这块和SQL语句非常类似</p>
</blockquote>
<h2 id="Generic"><a href="#Generic" class="headerlink" title="Generic"></a>Generic</h2><p>耗子叔在接下来的部分，展示了用<code>reflect</code>处理泛型情况。我这边简单地截取Map部分解析一下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TransformInPlace</span><span class="params">(slice, function <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> transform(slice, function, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// map的转换函数，slice为切片，function为对应的函数，inPlace表示是否原地处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transform</span><span class="params">(slice, function <span class="keyword">interface</span>&#123;&#125;, inPlace <span class="keyword">bool</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="comment">// 类型判断，必须为切片</span></span><br><span class="line">	sliceInType := reflect.ValueOf(slice)</span><br><span class="line">	<span class="keyword">if</span> sliceInType.Kind() != reflect.Slice &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;transform: not slice&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 函数的签名判断，即函数的入参必须和slice里的元素一致</span></span><br><span class="line">	fn := reflect.ValueOf(function)</span><br><span class="line">	elemType := sliceInType.Type().Elem()</span><br><span class="line">	<span class="keyword">if</span> !verifyFuncSignature(fn, elemType, <span class="literal">nil</span>) &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;trasform: function must be of type func(&quot;</span> + sliceInType.Type().Elem().String() + <span class="string">&quot;) outputElemType&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果是原地，则直接处理函数，结果会保存到入参中（这时入参一般为指针）</span></span><br><span class="line">	<span class="comment">// 如果非原地，那就需要新建一个切片，用来保存结果</span></span><br><span class="line">	sliceOutType := sliceInType</span><br><span class="line">	<span class="keyword">if</span> !inPlace &#123;</span><br><span class="line">		sliceOutType = reflect.MakeSlice(reflect.SliceOf(fn.Type().Out(<span class="number">0</span>)), sliceInType.Len(), sliceInType.Len())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; sliceInType.Len(); i++ &#123;</span><br><span class="line">		sliceOutType.Index(i).Set(fn.Call([]reflect.Value&#123;sliceInType.Index(i)&#125;)[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sliceOutType.Interface()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyFuncSignature</span><span class="params">(fn reflect.Value, types ...reflect.Type)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// 类型判断</span></span><br><span class="line">	<span class="keyword">if</span> fn.Kind() != reflect.Func &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 入参数量和函数签名一致，出参必须只有一个</span></span><br><span class="line">	<span class="keyword">if</span> (fn.Type().NumIn() != <span class="built_in">len</span>(types)<span class="number">-1</span>) || (fn.Type().NumOut() != <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 每个函数入参的类型校验</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(types)<span class="number">-1</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> fn.Type().In(i) != types[i] &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 出参类型的校验</span></span><br><span class="line">	outType := types[<span class="built_in">len</span>(types)<span class="number">-1</span>]</span><br><span class="line">	<span class="keyword">if</span> outType != <span class="literal">nil</span> &amp;&amp; fn.Type().Out(<span class="number">0</span>) != outType &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仔细阅读这一块代码，我们能学到很多反射方面的知识，尤其是并不常用的函数相关的。</p>
<p>但是，我不建议大家在实际项目中直接使用这一块代码，毕竟其中大量的反射操作是比较耗时的，尤其是在延迟非常敏感的web服务器中。</p>
<p>如果我们多花点时间、直接编写指定类型的代码，那么就能在编译期发现错误，运行时也可以跳过反射的耗时。</p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-5/" class="post-title-link" itemprop="url">Go编程模式 - 5.函数式选项</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:31:59" itemprop="dateCreated datePublished" datetime="2021-02-20T18:31:59+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#ServerConfig">一个常见的HTTP服务器</a></li>
<li><a href="#SplitConfig">拆分可选配置</a></li>
<li><a href="#Functional-Option">函数式选项</a></li>
<li><a href="#Further">更进一步</a></li>
</ul>
<h2 id="ServerConfig"><a href="#ServerConfig" class="headerlink" title="ServerConfig"></a>ServerConfig</h2><p>我们先来看看一个常见的HTTP服务器的配置，它区分了2个必填参数与4个非必填参数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ServerCfg <span class="keyword">struct</span> &#123;</span><br><span class="line">	Addr     <span class="keyword">string</span>        <span class="comment">// 必填</span></span><br><span class="line">	Port     <span class="keyword">int</span>           <span class="comment">// 必填</span></span><br><span class="line">	Protocol <span class="keyword">string</span>        <span class="comment">// 非必填</span></span><br><span class="line">	Timeout  time.Duration <span class="comment">// 非必填</span></span><br><span class="line">	MaxConns <span class="keyword">int</span>           <span class="comment">// 非必填</span></span><br><span class="line">	TLS      *tls.Config   <span class="comment">// 非必填</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们要实现非常多种方法，来支持各种非必填的情况，示例如下</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>)</span> <span class="params">(*Server, error)</span></span>                                   &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTLSServer</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>, tls *tls.Config)</span> <span class="params">(*Server, error)</span></span>               &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServerWithTimeout</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>, timeout time.Duration)</span> <span class="params">(*Server, error)</span></span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTLSServerWithMaxConnAndTimeout</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>, maxconns <span class="keyword">int</span>, timeout time.Duration, tls *tls.Config)</span> <span class="params">(*Server, error)</span></span> &#123;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="SplitConfig"><a href="#SplitConfig" class="headerlink" title="SplitConfig"></a>SplitConfig</h2><p>编程的一大重点，就是要 <code>分离变化点和不变点</code>。这里，我们可以将必填项认为是不变点，而非必填则是变化点。</p>
<p>我们将非必填的选项拆分出来。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">	Protocol <span class="keyword">string</span></span><br><span class="line">	Timeout  time.Duration</span><br><span class="line">	MaxConns <span class="keyword">int</span></span><br><span class="line">	TLS      *tls.Config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">	Addr <span class="keyword">string</span></span><br><span class="line">	Port <span class="keyword">int</span></span><br><span class="line">	Conf *Config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>, conf *Config)</span> <span class="params">(*Server, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Server&#123;</span><br><span class="line">		Addr: addr,</span><br><span class="line">		Port: port,</span><br><span class="line">		Conf: conf,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	srv1, _ := NewServer(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	conf := Config&#123;Protocol: <span class="string">&quot;tcp&quot;</span>, Timeout: <span class="number">60</span> * time.Second&#125;</span><br><span class="line">	srv2, _ := NewServer(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>, &amp;conf)</span><br><span class="line"></span><br><span class="line">	fmt.Println(srv1, srv2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，其实已经满足大部分的开发需求了。那么，我们将进入今天的重点。</p>
<h2 id="Functional-Option"><a href="#Functional-Option" class="headerlink" title="Functional Option"></a>Functional Option</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">	Addr     <span class="keyword">string</span></span><br><span class="line">	Port     <span class="keyword">int</span></span><br><span class="line">	Protocol <span class="keyword">string</span></span><br><span class="line">	Timeout  time.Duration</span><br><span class="line">	MaxConns <span class="keyword">int</span></span><br><span class="line">	TLS      *tls.Config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个Option类型的函数，它操作了Server这个对象</span></span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(*Server)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面是对四个可选参数的配置函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Protocol</span><span class="params">(p <span class="keyword">string</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(s *Server)</span></span> &#123;</span><br><span class="line">		s.Protocol = p</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Timeout</span><span class="params">(timeout time.Duration)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(s *Server)</span></span> &#123;</span><br><span class="line">		s.Timeout = timeout</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MaxConns</span><span class="params">(maxconns <span class="keyword">int</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(s *Server)</span></span> &#123;</span><br><span class="line">		s.MaxConns = maxconns</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TLS</span><span class="params">(tls *tls.Config)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(s *Server)</span></span> &#123;</span><br><span class="line">		s.TLS = tls</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用到了不定参数的特性，将任意个option应用到Server上</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>, options ...Option)</span> <span class="params">(*Server, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 先填写默认值</span></span><br><span class="line">	srv := Server&#123;</span><br><span class="line">		Addr:     addr,</span><br><span class="line">		Port:     port,</span><br><span class="line">		Protocol: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">		Timeout:  <span class="number">30</span> * time.Second,</span><br><span class="line">		MaxConns: <span class="number">1000</span>,</span><br><span class="line">		TLS:      <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 应用任意个option</span></span><br><span class="line">	<span class="keyword">for</span> _, option := <span class="keyword">range</span> options &#123;</span><br><span class="line">		option(&amp;srv)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;srv, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s1, _ := NewServer(<span class="string">&quot;localhost&quot;</span>, <span class="number">1024</span>)</span><br><span class="line">	s2, _ := NewServer(<span class="string">&quot;localhost&quot;</span>, <span class="number">2048</span>, Protocol(<span class="string">&quot;udp&quot;</span>))</span><br><span class="line">	s3, _ := NewServer(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">8080</span>, Timeout(<span class="number">300</span>*time.Second), MaxConns(<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">	fmt.Println(s1, s2, s3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>耗子哥给出了6个点，但我感受最深的是以下两点：</p>
<ol>
<li>可读性强，将配置都转化成了对应的函数项option</li>
<li>扩展性好，新增参数只需要增加一个对应的方法</li>
</ol>
<p>那么对应的代价呢？就是需要编写多个Option函数，代码量会有所增加。</p>
<p>如果大家对这个感兴趣，可以去看一下Rob Pike的<a target="_blank" rel="noopener" href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">这篇blog</a> 。</p>
<h2 id="Further"><a href="#Further" class="headerlink" title="Further"></a>Further</h2><p>顺着耗子叔的例子，我们再思考一下，如果配置的过程中有参数限制，那么我们该怎么办呢？</p>
<p>首先，我们改造一下函数Option</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回错误</span></span><br><span class="line"><span class="keyword">type</span> OptionWithError <span class="function"><span class="keyword">func</span><span class="params">(*Server)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>

<p>然后，我们改造一下其中两个函数作为示例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Protocol</span><span class="params">(p <span class="keyword">string</span>)</span> <span class="title">OptionWithError</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(s *Server)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> p == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.New(<span class="string">&quot;empty protocol&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		s.Protocol = p</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Timeout</span><span class="params">(timeout time.Duration)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(s *Server)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> timeout.Seconds() &lt; <span class="number">1</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.New(<span class="string">&quot;time out should not less than 1s&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		s.Timeout = timeout</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再做一次改造</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(addr <span class="keyword">string</span>, port <span class="keyword">int</span>, options ...OptionWithError)</span> <span class="params">(*Server, error)</span></span> &#123;</span><br><span class="line">	srv := Server&#123;</span><br><span class="line">		Addr:     addr,</span><br><span class="line">		Port:     port,</span><br><span class="line">		Protocol: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">		Timeout:  <span class="number">30</span> * time.Second,</span><br><span class="line">		MaxConns: <span class="number">1000</span>,</span><br><span class="line">		TLS:      <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 增加了一个参数验证的步骤</span></span><br><span class="line">	<span class="keyword">for</span> _, option := <span class="keyword">range</span> options &#123;</span><br><span class="line">		<span class="keyword">if</span> err := option(&amp;srv); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;srv, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改造基本到此完成，希望能给大家带来一定的帮助。</p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-4/" class="post-title-link" itemprop="url">Go编程模式 - 4.错误处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:31:57" itemprop="dateCreated datePublished" datetime="2021-02-20T18:31:57+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#Functional">函数式处理</a></li>
<li><a href="#ErrorObject">对象嵌入错误</a></li>
<li><a href="#Wrap">错误包装</a></li>
</ul>
<h2 id="Functional"><a href="#Functional" class="headerlink" title="Functional"></a>Functional</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Number <span class="keyword">struct</span> &#123;</span><br><span class="line">	a <span class="keyword">int</span></span><br><span class="line">	b <span class="keyword">string</span></span><br><span class="line">	c <span class="keyword">bool</span></span><br><span class="line">	d []<span class="keyword">int32</span></span><br><span class="line">	e error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Number)</span> <span class="title">parse</span><span class="params">(r io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;n.a); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;n.b); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;n.c); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;n.d); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;n.e); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>引入了函数式编程的方式，我们看看有什么改变</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Number)</span> <span class="title">parse</span><span class="params">(r io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 先定义一个error</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义函数，注意这里的err的作用域是来自上面定义的</span></span><br><span class="line">	read := <span class="function"><span class="keyword">func</span><span class="params">(data <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">		<span class="comment">// 先检查error，如果已经有错误则不检查</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		err = binary.Read(r, binary.BigEndian, data)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注意，这个函数的调用逻辑和之前的差别在于一点：</span></span><br><span class="line">	<span class="comment">// 即使前面的发生了error，下面的函数也会被调用</span></span><br><span class="line">	read(&amp;n.a)</span><br><span class="line">	read(&amp;n.b)</span><br><span class="line">	read(&amp;n.c)</span><br><span class="line">	read(&amp;n.d)</span><br><span class="line">	read(&amp;n.e)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ErrorObject"><a href="#ErrorObject" class="headerlink" title="ErrorObject"></a>ErrorObject</h2><p>先看一个标准库中的实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	input := bytes.NewReader([]<span class="keyword">byte</span>(<span class="string">&quot;hello&quot;</span>))</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 扫描数据，这里不会直接返回错误</span></span><br><span class="line">	scanner := bufio.NewScanner(input)</span><br><span class="line">	<span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">		token := scanner.Text()</span><br><span class="line">		fmt.Println(token)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 从Err()方法中获取错误</span></span><br><span class="line">	<span class="keyword">if</span> err := scanner.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它的根本思想，是将<code>error</code>嵌入到了对象中。那我们借鉴一下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">struct</span> &#123;</span><br><span class="line">	r   io.Reader</span><br><span class="line">	err error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">read</span><span class="params">(data <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.err == <span class="literal">nil</span> &#123;</span><br><span class="line">		r.err = binary.Read(r.r, binary.BigEndian, data)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Number)</span> <span class="title">parse</span><span class="params">(reader io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	r := Reader&#123;r: reader&#125;</span><br><span class="line"></span><br><span class="line">	r.read(&amp;n.a)</span><br><span class="line">	r.read(&amp;n.b)</span><br><span class="line">	r.read(&amp;n.c)</span><br><span class="line">	r.read(&amp;n.d)</span><br><span class="line">	r.read(&amp;n.e)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r.err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>捎带提一句：个人不太喜欢上面<code>scanner</code>的错误处理方式，这个要求使用方对这个包很熟悉，否则很容易忘掉后面的错误处理逻辑。但后面处理错误的逻辑，就很直接地将错误返回，可读性很强。</p>
<h2 id="Wrap"><a href="#Wrap" class="headerlink" title="Wrap"></a>Wrap</h2><p>耗子叔给的例子是调用了<code>github.com/pkg/errors</code>下的wrap包，不过我更倾向于直接用原生的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 原始 error</span></span><br><span class="line">	err := errors.New(<span class="string">&quot;level 1&quot;</span>)</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="comment">// level 1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// wrap一下error，注意error的占位符是%w</span></span><br><span class="line">	wraped := fmt.Errorf(<span class="string">&quot;%v: %w&quot;</span>, <span class="string">&quot;level 2&quot;</span>, err)</span><br><span class="line">	fmt.Println(wraped)</span><br><span class="line">	<span class="comment">// level 2: level 1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// unwrap 后获得原来的错误</span></span><br><span class="line">	unwraped := errors.Unwrap(wraped)</span><br><span class="line">	fmt.Println(unwraped)</span><br><span class="line">	<span class="comment">// level 1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 过度unwrap会导致错误变成nil</span></span><br><span class="line">	unwraped2 := errors.Unwrap(unwraped)</span><br><span class="line">	fmt.Println(unwraped2)</span><br><span class="line">	<span class="comment">// nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但在实际项目实践中，<code>Wrap</code>的这个特性并不好用：</p>
<p>如何Wrap Error，在多人协同开发、多模块开发过程中，很难统一。而一旦不统一，容易出现示例中的过度Unwrap的情况。</p>
<p>所以，我认为与其花大精力在制定错误的标准上，还不如利用<code>fmt.Errorf</code>将错误信息直观地表述出来。</p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-3/" class="post-title-link" itemprop="url">Go编程模式 - 3.继承与嵌入</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:31:54" itemprop="dateCreated datePublished" datetime="2021-02-20T18:31:54+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#Embedded">嵌入和委托</a></li>
<li><a href="#IoC">反转控制</a></li>
</ul>
<h2 id="Embedded"><a href="#Embedded" class="headerlink" title="Embedded"></a>Embedded</h2><p>接口定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义了两种interface</span></span><br><span class="line"><span class="keyword">type</span> Painter <span class="keyword">interface</span> &#123;</span><br><span class="line">	Paint()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Clicker <span class="keyword">interface</span> &#123;</span><br><span class="line">	Click()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Label 实现了 Painter</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准组件，用于嵌入</span></span><br><span class="line"><span class="keyword">type</span> Widget <span class="keyword">struct</span> &#123;</span><br><span class="line">	X, Y <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Label 实现了 Painter</span></span><br><span class="line"><span class="keyword">type</span> Label <span class="keyword">struct</span> &#123;</span><br><span class="line">	Widget        <span class="comment">// Embedding (delegation)</span></span><br><span class="line">	Text   <span class="keyword">string</span> <span class="comment">// Aggregation</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(label Label)</span> <span class="title">Paint</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%p:Label.Paint(%q)\n&quot;</span>, &amp;label, label.Text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ListBox实现了Painter和Clicker</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListBox声明了Paint和Click，所以实现了Painter和Clicker</span></span><br><span class="line"><span class="keyword">type</span> ListBox <span class="keyword">struct</span> &#123;</span><br><span class="line">	Widget          <span class="comment">// Embedding (delegation)</span></span><br><span class="line">	Texts  []<span class="keyword">string</span> <span class="comment">// Aggregation</span></span><br><span class="line">	Index  <span class="keyword">int</span>      <span class="comment">// Aggregation</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(listBox ListBox)</span> <span class="title">Paint</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ListBox.Paint(%q)\n&quot;</span>, listBox.Texts)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(listBox ListBox)</span> <span class="title">Click</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ListBox.Click(%q)\n&quot;</span>, listBox.Texts)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Button也实现了Painter和Clicker</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Button 继承了Label，所以直接实现了Painter</span></span><br><span class="line"><span class="comment">// 接下来，Button又声明了Paint和Click，所以实现了Painter和Clicker，其中Paint方法被覆</span></span><br><span class="line"><span class="keyword">type</span> Button <span class="keyword">struct</span> &#123;</span><br><span class="line">	Label <span class="comment">// Embedding (delegation)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(button Button)</span> <span class="title">Paint</span><span class="params">()</span></span> &#123; <span class="comment">// Override</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Button.Paint(%s)\n&quot;</span>, button.Text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(button Button)</span> <span class="title">Click</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Button.Click(%s)\n&quot;</span>, button.Text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法调用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	label := Label&#123;Widget&#123;<span class="number">10</span>, <span class="number">70</span>&#125;, <span class="string">&quot;Label&quot;</span>&#125;</span><br><span class="line">	button1 := Button&#123;Label&#123;Widget&#123;<span class="number">10</span>, <span class="number">70</span>&#125;, <span class="string">&quot;OK&quot;</span>&#125;&#125;</span><br><span class="line">	button2 := Button&#123;Label&#123;Widget&#123;<span class="number">50</span>, <span class="number">70</span>&#125;, <span class="string">&quot;Cancel&quot;</span>&#125;&#125;</span><br><span class="line">	listBox := ListBox&#123;Widget&#123;<span class="number">10</span>, <span class="number">40</span>&#125;,</span><br><span class="line">		[]<span class="keyword">string</span>&#123;<span class="string">&quot;AL&quot;</span>, <span class="string">&quot;AK&quot;</span>, <span class="string">&quot;AZ&quot;</span>, <span class="string">&quot;AR&quot;</span>&#125;, <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, painter := <span class="keyword">range</span> []Painter&#123;label, listBox, button1, button2&#125; &#123;</span><br><span class="line">		painter.Paint()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, widget := <span class="keyword">range</span> []<span class="keyword">interface</span>&#123;&#125;&#123;label, listBox, button1, button2&#125; &#123;</span><br><span class="line">		<span class="comment">// 默认都实现了Painter接口，可以直接调用</span></span><br><span class="line">		widget.(Painter).Paint()</span><br><span class="line">		<span class="keyword">if</span> clicker, ok := widget.(Clicker); ok &#123;</span><br><span class="line">			clicker.Click()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子代码很多，我个人认为重点可以归纳为一句话：</p>
<p><strong>用嵌入实现方法的继承，减少代码的冗余度</strong></p>
<p>耗子叔的例子很精彩，不过我个人不太喜欢<code>interface</code>这个数据类型（main函数中），有没有什么优化的空间呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义两种方法的组合</span></span><br><span class="line"><span class="keyword">type</span> PaintClicker <span class="keyword">interface</span> &#123;</span><br><span class="line">	Painter</span><br><span class="line">	Clicker</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 在上面的例子中，interface传参其实不太优雅，有没有更优雅的实现呢？那就用组合的interface</span></span><br><span class="line">	<span class="keyword">for</span> _, widget := <span class="keyword">range</span> []PaintClicker&#123;listBox, button1, button2&#125; &#123;</span><br><span class="line">		widget.Paint()</span><br><span class="line">		widget.Click()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h2><p>先看一个Int集合的最基本实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Int集合，用于最基础的增删查</span></span><br><span class="line"><span class="keyword">type</span> IntSet <span class="keyword">struct</span> &#123;</span><br><span class="line">	data <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIntSet</span><span class="params">()</span> <span class="title">IntSet</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> IntSet&#123;<span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *IntSet)</span> <span class="title">Add</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123; set.data[x] = <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *IntSet)</span> <span class="title">Delete</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123; <span class="built_in">delete</span>(set.data, x) &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *IntSet)</span> <span class="title">Contains</span><span class="params">(x <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> set.data[x] &#125;</span><br></pre></td></tr></table></figure>

<p>现在，需求来了，我们希望对这个Int集合的操作是可撤销的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可撤销的Int集合，依赖于IntSet，我们看看基本实现</span></span><br><span class="line"><span class="keyword">type</span> UndoableIntSet <span class="keyword">struct</span> &#123; <span class="comment">// Poor style</span></span><br><span class="line">	IntSet    <span class="comment">// Embedding (delegation)</span></span><br><span class="line">	functions []<span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUndoableIntSet</span><span class="params">()</span> <span class="title">UndoableIntSet</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> UndoableIntSet&#123;NewIntSet(), <span class="literal">nil</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增</span></span><br><span class="line"><span class="comment">// 不存在元素时：添加元素，并新增撤销函数：删除</span></span><br><span class="line"><span class="comment">// 存在元素时：不做任何操作，并新增撤销函数：空</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *UndoableIntSet)</span> <span class="title">Add</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123; <span class="comment">// Override</span></span><br><span class="line">	<span class="keyword">if</span> !set.Contains(x) &#123;</span><br><span class="line">		set.data[x] = <span class="literal">true</span></span><br><span class="line">		set.functions = <span class="built_in">append</span>(set.functions, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; set.Delete(x) &#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		set.functions = <span class="built_in">append</span>(set.functions, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除，与新增相反</span></span><br><span class="line"><span class="comment">// 存在元素时：删除元素，并新增撤销函数：新增</span></span><br><span class="line"><span class="comment">// 不存在元素时：不做任何操作，并新增撤销函数：空</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *UndoableIntSet)</span> <span class="title">Delete</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123; <span class="comment">// Override</span></span><br><span class="line">	<span class="keyword">if</span> set.Contains(x) &#123;</span><br><span class="line">		<span class="built_in">delete</span>(set.data, x)</span><br><span class="line">		set.functions = <span class="built_in">append</span>(set.functions, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; set.Add(x) &#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		set.functions = <span class="built_in">append</span>(set.functions, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 撤销：执行最后一个撤销函数function</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *UndoableIntSet)</span> <span class="title">Undo</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(set.functions) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;No functions to undo&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	index := <span class="built_in">len</span>(set.functions) - <span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> function := set.functions[index]; function != <span class="literal">nil</span> &#123;</span><br><span class="line">		function()</span><br><span class="line">		set.functions[index] = <span class="literal">nil</span> <span class="comment">// For garbage collection</span></span><br><span class="line">	&#125;</span><br><span class="line">	set.functions = set.functions[:index]</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的实现是一种顺序逻辑的思路，整体还是挺麻烦的。有没有优化思路呢？</p>
<p>定义一下Undo这个结构。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Undo []<span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(undo *Undo)</span> <span class="title">Add</span><span class="params">(function <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">	*undo = <span class="built_in">append</span>(*undo, function)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(undo *Undo)</span> <span class="title">Undo</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	functions := *undo</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(functions) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;No functions to undo&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	index := <span class="built_in">len</span>(functions) - <span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> function := functions[index]; function != <span class="literal">nil</span> &#123;</span><br><span class="line">		function()</span><br><span class="line">		functions[index] = <span class="literal">nil</span> <span class="comment">// For garbage collection</span></span><br><span class="line">	&#125;</span><br><span class="line">	*undo = functions[:index]</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>细品一下这里的实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> IntSet2 <span class="keyword">struct</span> &#123;</span><br><span class="line">	data <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span></span><br><span class="line">	undo Undo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIntSet2</span><span class="params">()</span> <span class="title">IntSet2</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> IntSet2&#123;data: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *IntSet2)</span> <span class="title">Undo</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> set.undo.Undo()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *IntSet2)</span> <span class="title">Contains</span><span class="params">(x <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> set.data[x]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *IntSet2)</span> <span class="title">Add</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !set.Contains(x) &#123;</span><br><span class="line">		set.data[x] = <span class="literal">true</span></span><br><span class="line">		set.undo.Add(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; set.Delete(x) &#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		set.undo.Add(<span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(set *IntSet2)</span> <span class="title">Delete</span><span class="params">(x <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> set.Contains(x) &#123;</span><br><span class="line">		<span class="built_in">delete</span>(set.data, x)</span><br><span class="line">		set.undo.Add(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; set.Add(x) &#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		set.undo.Add(<span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看一下，这块代码的前后逻辑有了啥变化：</p>
<ol>
<li>之前，撤销函数是在Add/Delete时添加的，函数中包含了IntSet的操作，也就是 <strong>Undo依赖IntSet</strong></li>
<li>而修改之后，撤销函数被抽象为Undo，撤销相关的工作直接调用Undo相关的工作即可，也就是 <strong>IntSet依赖Undo</strong></li>
</ol>
<p>我们再来分析一下</p>
<ul>
<li>Undo是控制逻辑 - 撤销动作</li>
<li>IntSet是业务逻辑 - 保存数据的功能。</li>
</ul>
<p><strong>业务逻辑依赖控制逻辑，才能保证在复杂业务逻辑变化场景下，代码更健壮！</strong></p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-2/" class="post-title-link" itemprop="url">Go编程模式 - 2.基础编码下</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:31:50" itemprop="dateCreated datePublished" datetime="2021-02-20T18:31:50+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#Time">时间格式</a></li>
<li><a href="#Performance1">性能1</a></li>
<li><a href="#Performance2">性能2</a></li>
<li><a href="#Further">扩展阅读</a></li>
</ul>
<p>注：切勿过早优化！</p>
<h2 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h2><p>这部分的内容实战项目中用得不多，大家记住耗子叔总结出来的一个原则即可：</p>
<blockquote>
<p>尽量用<code>time.Time</code>和<code>time.Duration</code>，如果必须用string，尽量用<code>time.RFC3339</code></p>
</blockquote>
<p>然而现实情况并没有那么理想，实际项目中用得最频繁，还是自定义的<code>2006-01-02 15:04:05</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="Performance1"><a href="#Performance1" class="headerlink" title="Performance1"></a>Performance1</h2><h3 id="Itoa性能高于Sprint"><a href="#Itoa性能高于Sprint" class="headerlink" title="Itoa性能高于Sprint"></a>Itoa性能高于Sprint</h3><p>主要性能差异是由于<code>Sprint</code>针对的是复杂的字符串拼接，底层有个buffer，会在它的基础上进行一些字符串的拼接；</p>
<p>而<code>Itoa</code>直接通过一些位操作组合出字符串。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 170 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_Sprint</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		_ = fmt.Sprint(rand.Int())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 81.9 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_Itoa</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		_ = strconv.Itoa(rand.Int())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="减少string到byte的转换"><a href="#减少string到byte的转换" class="headerlink" title="减少string到byte的转换"></a>减少string到byte的转换</h3><p>主要了解go的<code>string</code>到<code>[]byte</code>的转换还是比较耗性能的，但大部分情况下无法避免这种转换。</p>
<p>我们注意一种场景即可：从<code>[]byte</code>转换为<code>string</code>，再转换为<code>[]byte</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 43.9 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_String2Bytes</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	data := <span class="string">&quot;Hello world&quot;</span></span><br><span class="line">	w := ioutil.Discard</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		w.Write([]<span class="keyword">byte</span>(data))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.06 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_Bytes</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	data := []<span class="keyword">byte</span>(<span class="string">&quot;Hello world&quot;</span>)</span><br><span class="line">	w := ioutil.Discard</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">		w.Write(data)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="切片能声明cap的，尽量初始化时声明"><a href="#切片能声明cap的，尽量初始化时声明" class="headerlink" title="切片能声明cap的，尽量初始化时声明"></a>切片能声明cap的，尽量初始化时声明</h3><p>了解slice的扩容机制就能很容易地理解。切片越长，影响越大。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> size = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4494 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_NoCap</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; b.N; n++ &#123;</span><br><span class="line">		data := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">for</span> k := <span class="number">0</span>; k &lt; size; k++ &#123;</span><br><span class="line">			data = <span class="built_in">append</span>(data, k)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2086 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_Cap</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; b.N; n++ &#123;</span><br><span class="line">		data := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, size)</span><br><span class="line">		<span class="keyword">for</span> k := <span class="number">0</span>; k &lt; size; k++ &#123;</span><br><span class="line">			data = <span class="built_in">append</span>(data, k)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="避免用string做大量字符串的拼接"><a href="#避免用string做大量字符串的拼接" class="headerlink" title="避免用string做大量字符串的拼接"></a>避免用string做大量字符串的拼接</h3><p>频繁拼接字符串的场景并不多，了解即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> strLen = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.0107 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_StringAdd</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> str <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; strLen; n++ &#123;</span><br><span class="line">		str += <span class="string">&quot;x&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.000154 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_StringBuilder</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> builder strings.Builder</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; strLen; n++ &#123;</span><br><span class="line">		builder.WriteString(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.000118 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_BytesBuffer</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; strLen; n++ &#123;</span><br><span class="line">		buffer.WriteString(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Performance2"><a href="#Performance2" class="headerlink" title="Performance2"></a>Performance2</h2><h3 id="并行操作用sync-WaitGroup控制"><a href="#并行操作用sync-WaitGroup控制" class="headerlink" title="并行操作用sync.WaitGroup控制"></a>并行操作用sync.WaitGroup控制</h3><h3 id="热点内存分配用sync-Pool"><a href="#热点内存分配用sync-Pool" class="headerlink" title="热点内存分配用sync.Pool"></a>热点内存分配用sync.Pool</h3><p>注意一下，一定要是<code>热点</code>，千万不要 <strong>过早优化</strong></p>
<h3 id="倾向于使用lock-free的atomic包"><a href="#倾向于使用lock-free的atomic包" class="headerlink" title="倾向于使用lock-free的atomic包"></a>倾向于使用lock-free的atomic包</h3><p>除了常用的<code>CAS</code>操作，还有<code>atomic.Value</code>的<code>Store</code>和<code>Load</code>操作，这里简单地放个实例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	v := atomic.Value&#123;&#125;</span><br><span class="line">	<span class="keyword">type</span> demo <span class="keyword">struct</span> &#123;</span><br><span class="line">		a <span class="keyword">int</span></span><br><span class="line">		b <span class="keyword">string</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v.Store(&amp;demo&#123;</span><br><span class="line">		a: <span class="number">1</span>,</span><br><span class="line">		b: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	data, ok := v.Load().(*demo)</span><br><span class="line">	fmt.Println(data, ok)</span><br><span class="line">	<span class="comment">// &amp;&#123;1 hello&#125; true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复杂场景下，还是建议用<code>mutex</code>。</p>
<h3 id="对磁盘的大量读写用bufio包"><a href="#对磁盘的大量读写用bufio包" class="headerlink" title="对磁盘的大量读写用bufio包"></a>对磁盘的大量读写用bufio包</h3><p><code>bufio.NewReader()</code>和<code>bufio.NewWriter()</code></p>
<h3 id="对正则表达式不要重复compile"><a href="#对正则表达式不要重复compile" class="headerlink" title="对正则表达式不要重复compile"></a>对正则表达式不要重复compile</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果匹配的格式不会变化，全局只初始化一次即可</span></span><br><span class="line"><span class="keyword">var</span> compiled = regexp.MustCompile(<span class="string">`^[a-z]+[0-9]+$`</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(compiled.MatchString(<span class="string">&quot;test123&quot;</span>))</span><br><span class="line">	fmt.Println(compiled.MatchString(<span class="string">&quot;test1234&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="用protobuf替换json"><a href="#用protobuf替换json" class="headerlink" title="用protobuf替换json"></a>用protobuf替换json</h3><p>go项目内部通信尽量用<code>protobuf</code>，但如果是对外提供api，比如web前端，<code>json</code>格式更方便。</p>
<h3 id="map的key尽量用int来代替string"><a href="#map的key尽量用int来代替string" class="headerlink" title="map的key尽量用int来代替string"></a>map的key尽量用int来代替string</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> size = <span class="number">1000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.0442 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_MapInt</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; size; i++ &#123;</span><br><span class="line">		m[i] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	b.ResetTimer()</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; size; n++ &#123;</span><br><span class="line">		_, _ = m[n]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.180 ns/op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Benchmark_MapString</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; size; i++ &#123;</span><br><span class="line">		m[strconv.Itoa(i)] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	b.ResetTimer()</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; size; n++ &#123;</span><br><span class="line">		_, _ = m[strconv.Itoa(n)]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例中<code>strconv.Itoa</code>函数对性能多少有点影响，但可以看到<code>string</code>和<code>int</code>的差距是在数量级的。</p>
<h2 id="Further"><a href="#Further" class="headerlink" title="Further"></a>Further</h2><p>PPT中给出了8个扩展阅读，大家根据情况自行阅读。</p>
<p>如果说你的时间只够读一个材料的话，我推荐大家反复品读一下<a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go.html">Effective Go</a></p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/go-patterns/go-patterns-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/20/go-patterns/go-patterns-1/" class="post-title-link" itemprop="url">Go编程模式 - 1.基础编码上</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 18:30:14" itemprop="dateCreated datePublished" datetime="2021-02-20T18:30:14+08:00">2021-02-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-10-22 14:36:57" itemprop="dateModified" datetime="2021-10-22T14:36:57+08:00">2021-10-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BB%8F%E5%85%B8%E5%93%81%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">经典品读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 注：本文的灵感来源于GOPHER 2020年大会陈皓的分享，原PPT的<a target="_blank" rel="noopener" href="https://www2.slideshare.net/haoel/go-programming-patterns?from_action=save">链接</a>可能并不方便获取，所以我下载了一份<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/tree/master/doc/Go_Programming_Patterns.pdf">PDF</a>到git仓，方便大家阅读。我将结合自己的实际项目经历，与大家一起细品这份文档。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#Slice-Internal">Slice的底层实现</a></li>
<li><a href="#Deep-Comparison">深度对比</a></li>
<li><a href="#Function-vs-Receiver">函数传参VS对象方法</a></li>
<li><a href="#Interface-Patterns">面向接口编程</a></li>
</ul>
<h3 id="Slice-Internal"><a href="#Slice-Internal" class="headerlink" title="Slice Internal"></a>Slice Internal</h3><p>关于Slice的实现，我之前有<a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading/blob/master/basic/data_struct.md#slice">一讲</a>专门分析过底层实现。考虑到很多朋友没有细看，那我就再简单地讲一下。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">	array unsafe.Pointer <span class="comment">// Slice底层保存数据的指针</span></span><br><span class="line">	<span class="built_in">len</span> <span class="keyword">int</span> <span class="comment">// 当前使用的长度</span></span><br><span class="line">	<span class="built_in">cap</span> <span class="keyword">int</span> <span class="comment">// 分配的长度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>掌握Slice的底层实现，能让你真正理解一些看似“奇怪的”现象：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    foo := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">    foo[<span class="number">3</span>] = <span class="number">42</span></span><br><span class="line">    foo[<span class="number">4</span>] = <span class="number">100</span></span><br><span class="line">    </span><br><span class="line">    bar := foo[<span class="number">1</span>:<span class="number">4</span>]</span><br><span class="line">    bar[<span class="number">1</span>] = <span class="number">99</span></span><br><span class="line">    </span><br><span class="line">    fmt.Println(foo)</span><br><span class="line">    <span class="comment">// [0 0 99 42 100]</span></span><br><span class="line">    fmt.Println(bar)</span><br><span class="line">    <span class="comment">// [0 99 42]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tip: bar和foo是共享slice结构体底层的array的，所以修改了bar数组，foo也会变化</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    a := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">32</span>)</span><br><span class="line">    b := a[<span class="number">1</span>:<span class="number">16</span>]</span><br><span class="line">    </span><br><span class="line">    a = <span class="built_in">append</span>(a, <span class="number">1</span>)</span><br><span class="line">    a[<span class="number">2</span>] = <span class="number">42</span></span><br><span class="line">  </span><br><span class="line">    fmt.Println(b)</span><br><span class="line">    <span class="comment">// [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tip: a和b原来是共享array的，但在a = append(a, 1)后发生了扩容，a和b指向的array发生了变化</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    path := []<span class="keyword">byte</span>(<span class="string">&quot;AAAA/BBBBBBBBB&quot;</span>)</span><br><span class="line">    sepIndex := bytes.IndexByte(path,<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    dir1 := path[:sepIndex]</span><br><span class="line">    dir2 := path[sepIndex+<span class="number">1</span>:]</span><br><span class="line">    fmt.Println(<span class="built_in">cap</span>(dir1),<span class="built_in">cap</span>(dir2))</span><br><span class="line">    <span class="comment">// 14 9</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;dir1 =&gt;&quot;</span>,<span class="keyword">string</span>(dir1))</span><br><span class="line">    <span class="comment">// dir1 =&gt; AAAA</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;dir2 =&gt;&quot;</span>,<span class="keyword">string</span>(dir2))</span><br><span class="line">    <span class="comment">// dir2 =&gt; BBBBBBBBB</span></span><br><span class="line">    </span><br><span class="line">    dir1 = <span class="built_in">append</span>(dir1,<span class="string">&quot;suffix&quot;</span>...)</span><br><span class="line">    fmt.Println(<span class="string">&quot;dir1 =&gt;&quot;</span>,<span class="keyword">string</span>(dir1))</span><br><span class="line">    <span class="comment">// dir1 =&gt; AAAAsuffix</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;dir2 =&gt;&quot;</span>,<span class="keyword">string</span>(dir2))</span><br><span class="line">    <span class="comment">// dir2 =&gt; uffixBBBB</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tip: 核心点在于理解dir1和dir2的cap分别是14和9。由于dir1的当前len=4，append的长度=6，4+6&lt;14，所以不会发生扩容</p>
</blockquote>
<h3 id="Deep-Comparison"><a href="#Deep-Comparison" class="headerlink" title="Deep Comparison"></a>Deep Comparison</h3><p>我们先看一下示例，<code>data</code>结构体中四个注释为<code>not comparable</code>表示无法直接用 == 符号对比</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;</span><br><span class="line">	num    <span class="keyword">int</span>               <span class="comment">// ok</span></span><br><span class="line">	checks [<span class="number">10</span>]<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span>   // <span class="title">not</span> <span class="title">comparable</span></span></span><br><span class="line">	doit   <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span>       // <span class="title">not</span> <span class="title">comparable</span></span></span><br><span class="line">	m      <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> <span class="comment">// not comparable</span></span><br><span class="line">	bytes  []<span class="keyword">byte</span>            <span class="comment">// not comparable</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	v1 := data&#123;&#125;</span><br><span class="line">	v2 := data&#123;&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;v1 == v2:&quot;</span>, reflect.DeepEqual(v1, v2))</span><br><span class="line">	<span class="comment">// prints: v1 == v2: true</span></span><br><span class="line"></span><br><span class="line">	m1 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">&quot;one&quot;</span>: <span class="string">&quot;a&quot;</span>, <span class="string">&quot;two&quot;</span>: <span class="string">&quot;b&quot;</span>&#125;</span><br><span class="line">	m2 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">&quot;two&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;one&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;m1 == m2:&quot;</span>, reflect.DeepEqual(m1, m2))</span><br><span class="line">	<span class="comment">// prints: m1 == m2: true</span></span><br><span class="line"></span><br><span class="line">	s1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">	s2 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;s1 == s2:&quot;</span>, reflect.DeepEqual(s1, s2))</span><br><span class="line">	<span class="comment">// prints: s1 == s2: true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tip： 示例比较复杂，其实要表达的内容比较简单：</p>
<p>函数、map、切片（不包括数组）以及它们的复合结构（如函数的数组），无法直接对比，只能用 reflect.DeepEqual</p>
</blockquote>
<h3 id="Function-vs-Receiver"><a href="#Function-vs-Receiver" class="headerlink" title="Function vs Receiver"></a>Function vs Receiver</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Sexual <span class="keyword">string</span></span><br><span class="line">	Age    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrintPerson</span><span class="params">(p *Person)</span></span> &#123; fmt.Printf(<span class="string">&quot;Name=%s, Sexual=%s, Age=%d\n&quot;</span>, p.Name, p.Sexual, p.Age) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">Print</span><span class="params">()</span></span>    &#123; fmt.Printf(<span class="string">&quot;Name=%s, Sexual=%s, Age=%d\n&quot;</span>, p.Name, p.Sexual, p.Age) &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> p = Person&#123;</span><br><span class="line">		Name: <span class="string">&quot;Hao Chen&quot;</span>, Sexual: <span class="string">&quot;Male&quot;</span>, Age: <span class="number">44</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PrintPerson(&amp;p)</span><br><span class="line">	<span class="comment">// Name=Hao Chen, Sexual=Male, Age=44</span></span><br><span class="line">	p.Print()</span><br><span class="line">	<span class="comment">// Name=Hao Chen, Sexual=Male, Age=44</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tip: 示例比较简单，但其中蕴含的意义非常大，如对Person这个对象的抽象、简化代码等。</p>
<p>另外值得一提的是，Go编译器会根据方法 <code>func (p *Person) Print()</code> 的定义，将 <code>p.Print()</code>中的p从<code>Person</code>转换为<code>*Person</code>。</p>
</blockquote>
<h3 id="Interface-Patterns"><a href="#Interface-Patterns" class="headerlink" title="Interface Patterns"></a>Interface Patterns</h3><p>这个模块非常重要，希望大家倒一杯水，细细品尝。</p>
<p>示例是一个很简单的interface实现，用来打印接口，我们看看代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Country <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> City <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Printable <span class="keyword">interface</span> &#123;</span><br><span class="line">	PrintStr()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Country)</span> <span class="title">PrintStr</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(c.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c City)</span> <span class="title">PrintStr</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(c.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c1 := Country&#123;<span class="string">&quot;China&quot;</span>&#125;</span><br><span class="line">	c2 := City&#123;<span class="string">&quot;Beijing&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> cList = []Printable&#123;c1, c2&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> cList &#123;</span><br><span class="line">		v.PrintStr()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，这时问题来了，如果我要实现N个<code>Printable</code>，就要定义N个strcut+N个<code>PrintStr()</code>方法。</p>
<p>前者的工作不能避免，而后者能否简化？那么示例来了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WithName <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Country <span class="keyword">struct</span> &#123;</span><br><span class="line">	WithName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> City <span class="keyword">struct</span> &#123;</span><br><span class="line">	WithName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Printable <span class="keyword">interface</span> &#123;</span><br><span class="line">	PrintStr()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c WithName)</span> <span class="title">PrintStr</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(c.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c1 := Country&#123;WithName&#123;<span class="string">&quot;China&quot;</span>&#125;&#125;</span><br><span class="line">	c2 := City&#123;WithName&#123;<span class="string">&quot;Beijing&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> cList = []Printable&#123;c1, c2&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> cList &#123;</span><br><span class="line">		v.PrintStr()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tip: 核心就是用 embedded 的特性来删除冗余的代码。当然，代价是初始化会稍微麻烦点。</p>
</blockquote>
<hr>
<p>这时候，陈皓又给出了一个例子，即打印的内容会根据具体的实现不同时，无法直接用<code>WithName</code>来实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Country <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> City <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Printable <span class="keyword">interface</span> &#123;</span><br><span class="line">	PrintStr()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Country)</span> <span class="title">PrintStr</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;Country:&quot;</span>, c.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c City)</span> <span class="title">PrintStr</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;City:&quot;</span>, c.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c1 := Country&#123;<span class="string">&quot;China&quot;</span>&#125;</span><br><span class="line">	c2 := City&#123;<span class="string">&quot;Beijing&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> cList = []Printable&#123;c1, c2&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> cList &#123;</span><br><span class="line">		v.PrintStr()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，我们要明确是否有必要优化。如果只有示例中这么几行代码，我们完全没必要改写。那如果系统真复杂到一定程度，我们该怎么办呢？</p>
<p>这是一个很发散性的问题，我这里给出一个个人比较常用的解决方案，作为参考。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WithTypeName <span class="keyword">struct</span> &#123;</span><br><span class="line">	Type <span class="keyword">string</span></span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Country <span class="keyword">struct</span> &#123;</span><br><span class="line">	WithTypeName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCountry</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">Printable</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Country&#123;WithTypeName&#123;<span class="string">&quot;Country&quot;</span>, name&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> City <span class="keyword">struct</span> &#123;</span><br><span class="line">	WithTypeName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCity</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">Printable</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> City&#123;WithTypeName&#123;<span class="string">&quot;City&quot;</span>, name&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Printable <span class="keyword">interface</span> &#123;</span><br><span class="line">	PrintStr()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c WithTypeName)</span> <span class="title">PrintStr</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s:%s\n&quot;</span>, c.Type, c.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c1 := NewCountry(<span class="string">&quot;China&quot;</span>)</span><br><span class="line">	c2 := NewCity(<span class="string">&quot;Beijing&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> cList = []Printable&#123;c1, c2&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> cList &#123;</span><br><span class="line">		v.PrintStr()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tip： 这种方法的好处有很多（先不谈弊端），比如可以将具体的实现<code>Country</code>和<code>City</code>私有化，不对外暴露实现细节。今天不做细谈。</p>
</blockquote>
<p>最后，送上一句经典：</p>
<p><strong>Program to an interface, not an implementation</strong></p>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/18/k8s/k8s-013/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Junedayday">
      <meta itemprop="description" content="Blog信息">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Junedayday Blog">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/18/k8s/k8s-013/" class="post-title-link" itemprop="url">【K8s源码品读】013：Phase 1 - kubelet - 节点上控制容器生命周期的管理者</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-18 16:55:59" itemprop="dateCreated datePublished" datetime="2021-02-18T16:55:59+08:00">2021-02-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-29 20:51:46" itemprop="dateModified" datetime="2021-03-29T20:51:46+08:00">2021-03-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">源码阅读</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="聚焦目标"><a href="#聚焦目标" class="headerlink" title="聚焦目标"></a>聚焦目标</h2><p>理解 kubelet 的运行机制</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#Run">运行的主函数</a></li>
<li><a href="#RunKubelet">运行kubelet</a></li>
<li><a href="#Kubelet">核心数据管理Kubelet</a></li>
<li><a href="#syncLoop">同步循环</a></li>
<li><a href="#handler">处理pod的同步工作</a></li>
<li><a href="#Summary">总结</a></li>
</ol>
<h2 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h2><p>从主函数找到run函数，代码较长，我精简了一下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(ctx context.Context, s *options.KubeletServer, kubeDeps *kubelet.Dependencies, featureGate featuregate.FeatureGate)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 一长串的配置初始化与验证</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// done channel，用来通知运行结束</span></span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 注册到configz模块</span></span><br><span class="line">	err = initConfigz(&amp;s.KubeletConfiguration)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">&quot;unable to register KubeletConfiguration with configz, error: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取节点的相关信息</span></span><br><span class="line">	hostName, err := nodeutil.GetHostname(s.HostnameOverride)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	nodeName, err := getNodeName(kubeDeps.Cloud, hostName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">  <span class="comment">// 独立运行模式</span></span><br><span class="line">	<span class="keyword">case</span> standaloneMode:</span><br><span class="line">	<span class="comment">// 对客户端进行初始化</span></span><br><span class="line">	<span class="keyword">case</span> kubeDeps.KubeClient == <span class="literal">nil</span>, kubeDeps.EventClient == <span class="literal">nil</span>, kubeDeps.HeartbeatClient == <span class="literal">nil</span>:</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cgroup 相关初始化</span></span><br><span class="line">	<span class="keyword">var</span> cgroupRoots []<span class="keyword">string</span></span><br><span class="line">	nodeAllocatableRoot := cm.NodeAllocatableRoot(s.CgroupRoot, s.CgroupsPerQOS, s.CgroupDriver)</span><br><span class="line">	cgroupRoots = <span class="built_in">append</span>(cgroupRoots, nodeAllocatableRoot)</span><br><span class="line">	kubeletCgroup, err := cm.GetKubeletContainer(s.KubeletCgroups)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Warningf(<span class="string">&quot;failed to get the kubelet&#x27;s cgroup: %v.  Kubelet system container metrics may be missing.&quot;</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> kubeletCgroup != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		cgroupRoots = <span class="built_in">append</span>(cgroupRoots, kubeletCgroup)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	runtimeCgroup, err := cm.GetRuntimeContainer(s.ContainerRuntime, s.RuntimeCgroups)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Warningf(<span class="string">&quot;failed to get the container runtime&#x27;s cgroup: %v. Runtime system container metrics may be missing.&quot;</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> runtimeCgroup != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		cgroupRoots = <span class="built_in">append</span>(cgroupRoots, runtimeCgroup)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.SystemCgroups != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		cgroupRoots = <span class="built_in">append</span>(cgroupRoots, s.SystemCgroups)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 下面一大块都是对 ContainerManager 的初始化</span></span><br><span class="line">	<span class="keyword">if</span> kubeDeps.ContainerManager == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> s.CgroupsPerQOS &amp;&amp; s.CgroupRoot == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			klog.Info(<span class="string">&quot;--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /&quot;</span>)</span><br><span class="line">			s.CgroupRoot = <span class="string">&quot;/&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">		<span class="comment">// cpu相关信息</span></span><br><span class="line">		<span class="keyword">var</span> reservedSystemCPUs cpuset.CPUSet</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ContainerManager的实例化</span></span><br><span class="line">		kubeDeps.ContainerManager, err = cm.NewContainerManager(</span><br><span class="line">			kubeDeps.Mounter,</span><br><span class="line">			kubeDeps.CAdvisorInterface,</span><br><span class="line">      <span class="comment">// Node 相关配置</span></span><br><span class="line">			cm.NodeConfig&#123;&#125;,</span><br><span class="line">			s.FailSwapOn,</span><br><span class="line">			devicePluginEnabled,</span><br><span class="line">			kubeDeps.Recorder)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 内存OOM相关</span></span><br><span class="line">	oomAdjuster := kubeDeps.OOMAdjuster</span><br><span class="line">	<span class="keyword">if</span> err := oomAdjuster.ApplyOOMScoreAdj(<span class="number">0</span>, <span class="keyword">int</span>(s.OOMScoreAdj)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Warning(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 预初始化Runtime</span></span><br><span class="line">	err = kubelet.PreInitRuntimeService(&amp;s.KubeletConfiguration,</span><br><span class="line">		kubeDeps, &amp;s.ContainerRuntimeOptions,</span><br><span class="line">		s.ContainerRuntime,</span><br><span class="line">		s.RuntimeCgroups,</span><br><span class="line">		s.RemoteRuntimeEndpoint,</span><br><span class="line">		s.RemoteImageEndpoint,</span><br><span class="line">		s.NonMasqueradeCIDR)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 运行Kubelet</span></span><br><span class="line">	<span class="keyword">if</span> err := RunKubelet(s, kubeDeps, s.RunOnce); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通知deamon的systemd</span></span><br><span class="line">	<span class="keyword">go</span> daemon.SdNotify(<span class="literal">false</span>, <span class="string">&quot;READY=1&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阻塞</span></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-done:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="RunKubelet"><a href="#RunKubelet" class="headerlink" title="RunKubelet"></a>RunKubelet</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunKubelet</span><span class="params">(kubeServer *options.KubeletServer, kubeDeps *kubelet.Dependencies, runOnce <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 获取节点信息</span></span><br><span class="line">  hostname, err := nodeutil.GetHostname(kubeServer.HostnameOverride)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	nodeName, err := getNodeName(kubeDeps.Cloud, hostname)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	hostnameOverridden := <span class="built_in">len</span>(kubeServer.HostnameOverride) &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建并初始化 kubelet</span></span><br><span class="line">	k, err := createAndInitKubelet()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create kubelet: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> runOnce &#123;</span><br><span class="line">		<span class="keyword">if</span> _, err := k.RunOnce(podCfg.Updates()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;runonce failed: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		klog.Info(<span class="string">&quot;Started kubelet as runonce&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 开始kubelet</span></span><br><span class="line">		startKubelet(k, podCfg, &amp;kubeServer.KubeletConfiguration, kubeDeps, kubeServer.EnableCAdvisorJSONEndpoints, kubeServer.EnableServer)</span><br><span class="line">		klog.Info(<span class="string">&quot;Started kubelet&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始运行，都是并发的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startKubelet</span><span class="params">(k kubelet.Bootstrap, podCfg *config.PodConfig, kubeCfg *kubeletconfiginternal.KubeletConfiguration, kubeDeps *kubelet.Dependencies, enableCAdvisorJSONEndpoints, enableServer <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 运行</span></span><br><span class="line">	<span class="keyword">go</span> k.Run(podCfg.Updates())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 开启kubelet的http服务端</span></span><br><span class="line">	<span class="keyword">if</span> enableServer &#123;</span><br><span class="line">		<span class="keyword">go</span> k.ListenAndServe(net.ParseIP(kubeCfg.Address), <span class="keyword">uint</span>(kubeCfg.Port), kubeDeps.TLSOptions, kubeDeps.Auth,</span><br><span class="line">			enableCAdvisorJSONEndpoints, kubeCfg.EnableDebuggingHandlers, kubeCfg.EnableContentionProfiling, kubeCfg.EnableSystemLogHandler)</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 只读端口</span></span><br><span class="line">	<span class="keyword">if</span> kubeCfg.ReadOnlyPort &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">go</span> k.ListenAndServeReadOnly(net.ParseIP(kubeCfg.Address), <span class="keyword">uint</span>(kubeCfg.ReadOnlyPort), enableCAdvisorJSONEndpoints)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.KubeletPodResources) &#123;</span><br><span class="line">		<span class="keyword">go</span> k.ListenAndServePodResources()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里的k是一个interface定义，我们需要回头看看</span></span><br><span class="line"><span class="keyword">type</span> Bootstrap <span class="keyword">interface</span> &#123;</span><br><span class="line">	GetConfiguration() kubeletconfiginternal.KubeletConfiguration</span><br><span class="line">	BirthCry()</span><br><span class="line">	StartGarbageCollection()</span><br><span class="line">	ListenAndServe(address net.IP, port <span class="keyword">uint</span>, tlsOptions *server.TLSOptions, auth server.AuthInterface, enableCAdvisorJSONEndpoints, enableDebuggingHandlers, enableContentionProfiling, enableSystemLogHandler <span class="keyword">bool</span>)</span><br><span class="line">	ListenAndServeReadOnly(address net.IP, port <span class="keyword">uint</span>, enableCAdvisorJSONEndpoints <span class="keyword">bool</span>)</span><br><span class="line">	ListenAndServePodResources()</span><br><span class="line">	Run(&lt;-<span class="keyword">chan</span> kubetypes.PodUpdate)</span><br><span class="line">	RunOnce(&lt;-<span class="keyword">chan</span> kubetypes.PodUpdate) ([]RunPodResult, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看对应的实例化函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createAndInitKubelet</span><span class="params">()</span> <span class="params">(k kubelet.Bootstrap, err error)</span></span> &#123;</span><br><span class="line">	k, err = kubelet.NewMainKubelet()</span><br><span class="line">	<span class="keyword">return</span> k, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMainKubelet</span><span class="params">()</span> <span class="params">(*Kubelet, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 参数的初始化</span></span><br><span class="line">	</span><br><span class="line">  <span class="comment">// klet 的实例化结构</span></span><br><span class="line">	klet := &amp;Kubelet&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 下面是klet中各种参数的填充</span></span><br><span class="line">	<span class="keyword">return</span> klet, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span> <span class="title">Run</span><span class="params">(updates &lt;-<span class="keyword">chan</span> kubetypes.PodUpdate)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 内部模块的初始化</span></span><br><span class="line">	<span class="keyword">if</span> err := kl.initializeModules(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		kl.recorder.Eventf(kl.nodeRef, v1.EventTypeWarning, events.KubeletSetupFailed, err.Error())</span><br><span class="line">		klog.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> kl.volumeManager.Run(kl.sourcesReady, wait.NeverStop)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kl.kubeClient != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// 与kube-apiserver同步节点状态</span></span><br><span class="line">		<span class="keyword">go</span> wait.Until(kl.syncNodeStatus, kl.nodeStatusUpdateFrequency, wait.NeverStop)</span><br><span class="line">		<span class="keyword">go</span> kl.fastStatusUpdateOnce()</span><br><span class="line">		<span class="keyword">go</span> kl.nodeLeaseController.Run(wait.NeverStop)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">go</span> wait.Until(kl.updateRuntimeUp, <span class="number">5</span>*time.Second, wait.NeverStop)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kl.makeIPTablesUtilChains &#123;</span><br><span class="line">		kl.initNetworkUtil()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个kill pod的goroutine</span></span><br><span class="line">	<span class="keyword">go</span> wait.Until(kl.podKiller.PerformPodKillingWork, <span class="number">1</span>*time.Second, wait.NeverStop)</span><br><span class="line"></span><br><span class="line">	kl.statusManager.Start()</span><br><span class="line">	kl.probeManager.Start()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> kl.runtimeClassManager != <span class="literal">nil</span> &#123;</span><br><span class="line">		kl.runtimeClassManager.Start(wait.NeverStop)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	kl.pleg.Start()</span><br><span class="line">  <span class="comment">// 同步的主逻辑</span></span><br><span class="line">	kl.syncLoop(updates, kl)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="syncLoop"><a href="#syncLoop" class="headerlink" title="syncLoop"></a>syncLoop</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span> <span class="title">syncLoop</span><span class="params">(updates &lt;-<span class="keyword">chan</span> kubetypes.PodUpdate, handler SyncHandler)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 开始运行kubelet的主同步循环</span></span><br><span class="line">	klog.Info(<span class="string">&quot;Starting kubelet main sync loop.&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ticker每秒一次</span></span><br><span class="line">	syncTicker := time.NewTicker(time.Second)</span><br><span class="line">	<span class="keyword">defer</span> syncTicker.Stop()</span><br><span class="line">  <span class="comment">// housekeeping 清理周期</span></span><br><span class="line">	housekeepingTicker := time.NewTicker(housekeepingPeriod)</span><br><span class="line">	<span class="keyword">defer</span> housekeepingTicker.Stop()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		kl.syncLoopMonitor.Store(kl.clock.Now())</span><br><span class="line">    <span class="comment">// 同步</span></span><br><span class="line">		<span class="keyword">if</span> !kl.syncLoopIteration(updates, handler, syncTicker.C, housekeepingTicker.C, plegCh) &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		kl.syncLoopMonitor.Store(kl.clock.Now())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的3个channel比较重要：configCh用于配置，syncCh用于触发同步，housekeepingCh用于触发清理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span> <span class="title">syncLoopIteration</span><span class="params">(configCh &lt;-<span class="keyword">chan</span> kubetypes.PodUpdate, handler SyncHandler,</span></span></span><br><span class="line"><span class="params"><span class="function">	syncCh &lt;-<span class="keyword">chan</span> time.Time, housekeepingCh &lt;-<span class="keyword">chan</span> time.Time, plegCh &lt;-<span class="keyword">chan</span> *pleg.PodLifecycleEvent)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> u, open := &lt;-configCh:</span><br><span class="line">    <span class="comment">// config channel关闭</span></span><br><span class="line">		<span class="keyword">if</span> !open &#123;</span><br><span class="line">			klog.Errorf(<span class="string">&quot;Update channel is closed. Exiting the sync loop.&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 对应不同的操作</span></span><br><span class="line">		<span class="keyword">switch</span> u.Op &#123;</span><br><span class="line">		<span class="keyword">case</span> kubetypes.ADD:</span><br><span class="line">			klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;SyncLoop (ADD, %q): %q&quot;</span>, u.Source, format.Pods(u.Pods))</span><br><span class="line">			handler.HandlePodAdditions(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.UPDATE:</span><br><span class="line">			klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;SyncLoop (UPDATE, %q): %q&quot;</span>, u.Source, format.PodsWithDeletionTimestamps(u.Pods))</span><br><span class="line">			handler.HandlePodUpdates(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.REMOVE:</span><br><span class="line">			klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;SyncLoop (REMOVE, %q): %q&quot;</span>, u.Source, format.Pods(u.Pods))</span><br><span class="line">			handler.HandlePodRemoves(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.RECONCILE:</span><br><span class="line">			klog.V(<span class="number">4</span>).Infof(<span class="string">&quot;SyncLoop (RECONCILE, %q): %q&quot;</span>, u.Source, format.Pods(u.Pods))</span><br><span class="line">			handler.HandlePodReconcile(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.DELETE:</span><br><span class="line">			klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;SyncLoop (DELETE, %q): %q&quot;</span>, u.Source, format.Pods(u.Pods))</span><br><span class="line">			handler.HandlePodUpdates(u.Pods)</span><br><span class="line">		<span class="keyword">case</span> kubetypes.SET:</span><br><span class="line">			klog.Errorf(<span class="string">&quot;Kubelet does not support snapshot update&quot;</span>)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			klog.Errorf(<span class="string">&quot;Invalid event type received: %d.&quot;</span>, u.Op)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		kl.sourcesReady.AddSource(u.Source)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> e := &lt;-plegCh:</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">case</span> &lt;-syncCh:</span><br><span class="line">		<span class="comment">// 获取需要同步的pod，里面的逻辑暂不细看</span></span><br><span class="line">    <span class="comment">// 我们在这里接收到示例中要创建的nginx pod</span></span><br><span class="line">		podsToSync := kl.getPodsToSync()</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(podsToSync) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		klog.V(<span class="number">4</span>).Infof(<span class="string">&quot;SyncLoop (SYNC): %d pods; %s&quot;</span>, <span class="built_in">len</span>(podsToSync), format.Pods(podsToSync))</span><br><span class="line">    <span class="comment">// 开始处理</span></span><br><span class="line">		handler.HandlePodSyncs(podsToSync)</span><br><span class="line">	<span class="keyword">case</span> update := &lt;-kl.livenessManager.Updates():</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> &lt;-housekeepingCh:</span><br><span class="line">		<span class="keyword">if</span> !kl.sourcesReady.AllReady() &#123;</span><br><span class="line">      <span class="comment">// 清理没有ready，直接跳过</span></span><br><span class="line">			klog.V(<span class="number">4</span>).Infof(<span class="string">&quot;SyncLoop (housekeeping, skipped): sources aren&#x27;t ready yet.&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 开始清理pod</span></span><br><span class="line">			klog.V(<span class="number">4</span>).Infof(<span class="string">&quot;SyncLoop (housekeeping)&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err := handler.HandlePodCleanups(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.Errorf(<span class="string">&quot;Failed cleaning pods: %v&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h2><p>往前查找代码，handler就是Kubelet</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span> <span class="title">HandlePodSyncs</span><span class="params">(pods []*v1.Pod)</span></span> &#123;</span><br><span class="line">	start := kl.clock.Now()</span><br><span class="line">	<span class="keyword">for</span> _, pod := <span class="keyword">range</span> pods &#123;</span><br><span class="line">    <span class="comment">// 获取pod，然后分发</span></span><br><span class="line">		mirrorPod, _ := kl.podManager.GetMirrorPodByPod(pod)</span><br><span class="line">		kl.dispatchWork(pod, kubetypes.SyncPodSync, mirrorPod, start)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span> <span class="title">dispatchWork</span><span class="params">(pod *v1.Pod, syncType kubetypes.SyncPodType, mirrorPod *v1.Pod, start time.Time)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 调用UpdatePod的函数</span></span><br><span class="line">	kl.podWorkers.UpdatePod(&amp;UpdatePodOptions&#123;</span><br><span class="line">		Pod:        pod,</span><br><span class="line">		MirrorPod:  mirrorPod,</span><br><span class="line">		UpdateType: syncType,</span><br><span class="line">		OnCompleteFunc: <span class="function"><span class="keyword">func</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				metrics.PodWorkerDuration.WithLabelValues(syncType.String()).Observe(metrics.SinceInSeconds(start))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查到初始化的地方 	klet.podWorkers = newPodWorkers(klet.syncPod, kubeDeps.Recorder, klet.workQueue, klet.resyncInterval, backOffPeriod, klet.podCache)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *podWorkers)</span> <span class="title">UpdatePod</span><span class="params">(options *UpdatePodOptions)</span></span> &#123;</span><br><span class="line">	pod := options.Pod</span><br><span class="line">	uid := pod.UID</span><br><span class="line">	<span class="keyword">var</span> podUpdates <span class="keyword">chan</span> UpdatePodOptions</span><br><span class="line">	<span class="keyword">var</span> exists <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	p.podLock.Lock()</span><br><span class="line">	<span class="keyword">defer</span> p.podLock.Unlock()</span><br><span class="line">  <span class="comment">// 当pod不存在时，满足示例，是新建的pod</span></span><br><span class="line">	<span class="keyword">if</span> podUpdates, exists = p.podUpdates[uid]; !exists &#123;</span><br><span class="line">		podUpdates = <span class="built_in">make</span>(<span class="keyword">chan</span> UpdatePodOptions, <span class="number">1</span>)</span><br><span class="line">		p.podUpdates[uid] = podUpdates</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 并发处理</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> runtime.HandleCrash()</span><br><span class="line">			p.managePodLoop(podUpdates)</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !p.isWorking[pod.UID] &#123;</span><br><span class="line">		p.isWorking[pod.UID] = <span class="literal">true</span></span><br><span class="line">		podUpdates &lt;- *options</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		update, found := p.lastUndeliveredWorkUpdate[pod.UID]</span><br><span class="line">		<span class="keyword">if</span> !found || update.UpdateType != kubetypes.SyncPodKill &#123;</span><br><span class="line">			p.lastUndeliveredWorkUpdate[pod.UID] = *options</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *podWorkers)</span> <span class="title">managePodLoop</span><span class="params">(podUpdates &lt;-<span class="keyword">chan</span> UpdatePodOptions)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> lastSyncTime time.Time</span><br><span class="line">	<span class="keyword">for</span> update := <span class="keyword">range</span> podUpdates &#123;</span><br><span class="line">		err := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">      <span class="comment">// 同步pod的函数</span></span><br><span class="line">			err = p.syncPodFn(syncPodOptions&#123;</span><br><span class="line">				mirrorPod:      update.MirrorPod,</span><br><span class="line">				pod:            update.Pod,</span><br><span class="line">				podStatus:      status,</span><br><span class="line">				killPodOptions: update.KillPodOptions,</span><br><span class="line">				updateType:     update.UpdateType,</span><br><span class="line">			&#125;)</span><br><span class="line">			lastSyncTime = time.Now()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;()</span><br><span class="line">		</span><br><span class="line">		p.wrapUp(update.Pod.UID, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到syncPodFn被实例化的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span> <span class="title">syncPod</span><span class="params">(o syncPodOptions)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 这里有一长串逻辑，不方便阅读，我们只关注最核心的部分</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调用 container runtime进行创建pod，再往下就是容器相关了</span></span><br><span class="line">	result := kl.containerRuntime.SyncPod(pod, podStatus, pullSecrets, kl.backOff)</span><br><span class="line">	kl.reasonCache.Update(pod.UID, result)</span><br><span class="line">	<span class="keyword">if</span> err := result.Error(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> _, r := <span class="keyword">range</span> result.SyncResults &#123;</span><br><span class="line">			<span class="keyword">if</span> r.Error != kubecontainer.ErrCrashLoopBackOff &amp;&amp; r.Error != images.ErrImagePullBackOff &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ol>
<li><p><code>kubelet</code>是kubernetes的<code>Node</code>节点上的管理者</p>
</li>
<li><p><code>kubelet</code>接收来自<code>kube-apiserver</code>上的pod消息，用<code>Ticker</code>这种周期性的方式触发同步函数</p>
</li>
<li><p><code>kubelet</code>会异步地对容器进行管理，调用对应容器的接口（Container Runtime Interface）</p>
</li>
</ol>
<blockquote>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/Junedayday/code_reading">https://github.com/Junedayday/code_reading</a></p>
<p>Blog: <a target="_blank" rel="noopener" href="http://junes.tech/">http://junes.tech/</a></p>
<p>Bilibili：<a target="_blank" rel="noopener" href="https://space.bilibili.com/293775192">https://space.bilibili.com/293775192</a></p>
<p>公众号：golangcoding</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Junedayday</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

<div class=BbeiAn-info">
  浙ICP备 -
  <a target="_blank" rel="noopener" href="http://www.miitbeian.gov.cn/">19051676号-1</a>
  </a>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  















  








  

  

</body>
</html>
